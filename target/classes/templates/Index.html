<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat-App | Dynamic Groups</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #e6e6e6;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #username-page {
            text-align: center;
            background: #ffffff;
            padding: 50px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            max-width: 400px;
            width: 90%;
        }
        #usernameForm input {
             margin-bottom: 15px; padding: 12px 15px; border: 1px solid #c8c8c8; border-radius: 8px; width: 100%; transition: border-color 0.3s;
        }
        #usernameForm input:focus { border-color: #128c7e; outline: none; }
        #usernameForm button {
            padding: 12px 25px; background-color: #128c7e; color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: 500; transition: background-color 0.3s, transform 0.1s;
        }
        #usernameForm button:hover { background-color: #075e54; }
        #usernameForm button:active { transform: scale(0.98); }

        #chat-page {
            display: none; width: 90%; max-width: 1200px; height: 90%; background: #ffffff; border-radius: 10px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); overflow: hidden; display: flex; flex-direction: row;
        }

        #sidebar {
            width: 280px; background-color: #f7f7f7; border-right: 1px solid #ddd; display: flex; flex-direction: column;
        }
        #sidebar-header {
            background-color: #075e54; color: white; padding: 20px 15px; font-size: 1.2em; font-weight: 500; text-align: left;
        }
        #userList { overflow-y: auto; padding: 0; }
        .user-item {
            padding: 12px 15px; border-bottom: 1px solid #efefef; font-weight: 400; color: #1f1f1f; display: flex; align-items: center; justify-content: space-between; transition: background-color 0.2s;
        }
        .user-item:hover { background-color: #e9e9e9; }
        .online-status { width: 8px; height: 8px; border-radius: 50%; background-color: #4cd964; margin-left: 10px; }
        .user-info { display: flex; align-items: center; gap: 10px; }


        .sidebar-avatar {
            width: 35px; height: 35px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-weight: 500; font-size: 15px; flex-shrink: 0;
        }
        #chat-container { flex: 1; display: flex; flex-direction: column; }

        .chat-header {
            background-color: #075e54; color: white; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center;
        }
        .chat-header h2 { margin: 0; font-size: 1.3em; font-weight: 500; }
        #currentUserDisplay { font-size: 0.9em; font-weight: 300; color: #dcf8c6; }

        #messageArea {
            flex: 1; overflow-y: auto; padding: 20px 20px 20px 10px; background-color: #ece5dd; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 40 40"><rect width="40" height="40" fill="%23E5DDD5"/><path d="M0 0h20v20H0zm20 20h20v20H20z" fill-opacity=".02" fill="%23000"/></svg>');
            display: flex; flex-direction: column; gap: 12px;
        }

        .message-container {
            display: flex; align-self: flex-start; gap: 8px;
        }

        .message {
            padding: 10px 14px 25px 14px; max-width: 60%; position: relative; word-wrap: break-word; min-width: 120px; box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        }

        .message.my-message {
            align-self: flex-end; background-color: #dcf8c6; border-radius: 10px 0 10px 10px;
        }

        .message.other-message {
            background-color: white; border-radius: 0 10px 10px 10px;
        }

        .message.event {
            background: #e1ffc7; color: #4a4a4a; font-weight: 500; font-style: normal; font-size: 0.9em; padding: 5px 15px; border-radius: 20px; align-self: center; max-width: fit-content;
        }

        .message .sender { font-weight: 700; color: #008069; margin-bottom: 2px; font-size: 0.85em; }
        .message.my-message .sender { color: #3b507e; }
        .message .content { font-size: 1em; color: #1f1f1f; line-height: 1.3; }

        .message .time { position: absolute; bottom: 5px; right: 8px; font-size: 0.6em; color: #888; }

        .message-form {
            padding: 10px 15px; background: #f0f2f5; display: flex; gap: 10px; align-items: center;
        }
        .message-form input[type="text"] {
            padding: 12px 20px; border: none; border-radius: 25px; outline: none; flex: 1; background-color: white; font-size: 15px;
        }
        .message-form button {
            background-color: #128c7e; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; padding: 0; font-size: 1.2em; display: flex; justify-content: center; align-items: center; transition: background-color 0.3s;
        }

        .message-container .avatar {
            width: 35px; height: 35px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-weight: 500; font-size: 15px; flex-shrink: 0;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<div id="username-page">
    <h2>Welcome to Chat</h2>
    <form id="usernameForm">
        <input type="text" id="groupnameInput" placeholder="Enter Group Name (e.g., TeamA)" required autocomplete="off">
        <input type="text" id="usernameInput" placeholder="Enter your unique username" required autocomplete="off">
        <button type="submit">Join Group</button>
    </form>
</div>

<div id="chat-page">
    <div id="sidebar">
        <div id="sidebar-header">
            <span id="currentGroupDisplay">Group: ...</span>
        </div>
        <div id="userList">
        </div>
    </div>

    <div id="chat-container">
        <div class="chat-header">
            <h2 id="groupHeaderName">Group Chat <span id="onlineUsersCount" style="font-size: 0.8em; font-weight: normal;">(0 Online)</span></h2>
            <span id="currentUserDisplay">You: ...</span>
        </div>

        <div id="messageArea"></div>

        <form id="messageForm" class="message-form">
            <input type="text" id="message" placeholder="Type your message here..." required autocomplete="off">
            <button type="submit">âž¤</button>
        </form>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    let stompClient = null;
    let username = null;
    let groupName = null;

    const usernamePage = document.querySelector('#username-page');
    const chatPage = document.querySelector('#chat-page');
    const usernameForm = document.querySelector('#usernameForm');
    const messageForm = document.querySelector('#messageForm');
    const messageInput = document.querySelector('#message');
    const messageArea = document.querySelector('#messageArea');
    const usernameInput = document.querySelector('#usernameInput');
    const groupnameInput = document.querySelector('#groupnameInput');

    const onlineUsersCountElement = document.querySelector('#onlineUsersCount');
    const currentUserDisplayElement = document.querySelector('#currentUserDisplay');
    const currentGroupDisplayElement = document.querySelector('#currentGroupDisplay');
    const groupHeaderNameElement = document.querySelector('#groupHeaderName');
    const userListElement = document.querySelector('#userList');

    function getColorForUsername(username) {
        let hash = 0;
        for (let i = 0; i < username.length; i++) {
            hash = username.charCodeAt(i) + ((hash << 5) - hash);
        }
        const colors = [
            '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3',
            '#03A9F4', '#00BCD4', '#009688', '#4CAF50', '#8BC34A',
            '#CDDC39', '#FFC107', '#FF9800', '#FF5722', '#795548'
        ];
        const colorIndex = Math.abs(hash % colors.length);
        return colors[colorIndex];
    }

    function createAvatar(sender, isSidebar = false) {
        const avatarElement = document.createElement('div');
        avatarElement.classList.add(isSidebar ? 'sidebar-avatar' : 'avatar');

        const initial = sender.charAt(0).toUpperCase();
        const color = getColorForUsername(sender);

        avatarElement.textContent = initial;
        avatarElement.style.backgroundColor = color;

        return avatarElement;
    }


    function connect(event) {
        username = usernameInput.value.trim();
        groupName = groupnameInput.value.trim();

        if(username && groupName) {
            usernamePage.style.display = 'none';
            chatPage.style.display = 'flex';

            groupHeaderNameElement.innerHTML = `${groupName} <span id="onlineUsersCount" style="font-size: 0.8em; font-weight: normal;">(Connecting...)</span>`;
            currentUserDisplayElement.textContent = `You: ${username}`;
            currentGroupDisplayElement.textContent = `Group: ${groupName}`;

            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, onConnected, onError);
        }
        event.preventDefault();
    }

    function onConnected() {
        stompClient.subscribe(`/topic/${groupName}`, onMessageReceived);

        stompClient.send("/app/chat.addUser",
            {},
            JSON.stringify({sender: username, type: 'JOIN', content: groupName})
        );

        loadChatHistory();
        updateOnlineCount();
        updateUserList();
    }

    function onError(error) {
        console.error('Could not connect to WebSocket server:', error);
        alert('Could not connect to WebSocket server. Please check the console.');
    }

    function loadChatHistory() {
        fetch(`/api/messages/recent?groupName=${groupName}`)
            .then(res => res.json())
            .then(messages => {
                messages.forEach(msg => showMessage(msg, true));
                messageArea.scrollTop = messageArea.scrollHeight;
            })
            .catch(error => console.error('Error fetching chat history:', error));
    }

    function updateOnlineCount() {
        fetch('/api/users/online')
            .then(res => res.json())
            .then(users => {
                const count = users.length;
                const countSpan = document.querySelector('#onlineUsersCount');
                if (countSpan) {
                     countSpan.textContent = `(${count} Online)`;
                }
            })
            .catch(error => console.error('Error fetching online users:', error));
    }

    function updateUserList() {
        userListElement.innerHTML = '';
        fetch('/api/users/online')
            .then(res => res.json())
            .then(users => {
                users.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.classList.add('user-item');

                    const userInfo = document.createElement('div');
                    userInfo.classList.add('user-info');

                    userInfo.appendChild(createAvatar(user.username, true));

                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = user.username;
                    userInfo.appendChild(nameSpan);

                    userItem.appendChild(userInfo);

                    const statusDot = document.createElement('span');
                    statusDot.classList.add('online-status');
                    userItem.appendChild(statusDot);

                    userListElement.appendChild(userItem);
                });
            })
            .catch(error => console.error('Error fetching user list:', error));
    }


    function sendMessage(event) {
        const messageContent = messageInput.value.trim();
        if(messageContent && stompClient) {
            const chatMessage = {
                sender: username,
                content: messageContent,
                type: 'CHAT'
            };
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
            messageInput.value = '';
        }
        event.preventDefault();
    }

    function onMessageReceived(payload) {
        const message = JSON.parse(payload.body);
        showMessage(message, false);

        if (message.type === 'JOIN' || message.type === 'LEAVE') {
            setTimeout(() => {
                updateOnlineCount();
                updateUserList();
            }, 500);
        }
    }

    function showMessage(message, isHistory) {
        const sender = message.sender;
        const timestamp = isHistory ? message.createdAt.substring(11, 16) : message.timestamp;

        const messageElement = document.createElement('div');
        messageElement.classList.add('message');

        if(message.type === 'JOIN' || message.type === 'LEAVE') {
            messageElement.classList.add('event');
            messageElement.textContent = sender + (message.type === 'JOIN' ? ` joined ${groupName}!` : ` left ${groupName}.`);
            messageArea.appendChild(messageElement);
        } else {

            if (sender === username) {
                messageElement.classList.add('my-message');
                messageArea.appendChild(messageElement);

            } else {
                const messageContainer = document.createElement('div');
                messageContainer.classList.add('message-container');

                messageContainer.appendChild(createAvatar(sender));

                messageElement.classList.add('other-message');

                messageArea.appendChild(messageContainer);
                messageContainer.appendChild(messageElement);
            }

            const senderElement = document.createElement('div');
            senderElement.classList.add('sender');
            senderElement.textContent = sender;
            messageElement.appendChild(senderElement);

            const contentElement = document.createElement('div');
            contentElement.classList.add('content');
            contentElement.textContent = message.content;
            messageElement.appendChild(contentElement);

            const timeElement = document.createElement('span');
            timeElement.classList.add('time');
            timeElement.textContent = timestamp;
            messageElement.appendChild(timeElement);
        }

        if (!isHistory) {
            messageArea.scrollTop = messageArea.scrollHeight;
        }
    }

    usernameForm.addEventListener('submit', connect, true);
    messageForm.addEventListener('submit', sendMessage, true);
</script>
</body>
</html>